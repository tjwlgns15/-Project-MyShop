<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">
<head>
  <title>ê²°ì œí•˜ê¸°</title>
  <!-- í¬íŠ¸ì› ê²°ì œ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
  <style>
    .payment-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .payment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .page-title {
      font-size: 24px;
      font-weight: bold;
    }
    .order-summary {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .section-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .summary-label {
      color: #555;
    }
    .summary-value {
      font-weight: bold;
      text-align: right;
    }
    .total-row {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #ddd;
      font-size: 18px;
    }
    .total-label {
      font-weight: bold;
    }
    .total-value {
      font-weight: bold;
      color: #0066cc;
    }
    .payment-methods {
      margin-bottom: 30px;
    }
    .payment-method {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .payment-method:hover, .payment-method.active {
      border-color: #0066cc;
      background-color: #f0f7ff;
    }
    .payment-method-radio {
      margin-right: 15px;
    }
    .payment-method-icon {
      width: 24px;
      height: 24px;
      margin-right: 10px;
    }
    .payment-method-name {
      font-weight: bold;
    }
    .payment-agreement {
      margin-bottom: 30px;
    }
    .agreement-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .agreement-checkbox {
      margin-right: 10px;
    }
    .agreement-text {
      font-size: 14px;
    }
    .required {
      color: #ff3b30;
    }
    .payment-button {
      display: block;
      width: 100%;
      padding: 15px;
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      margin-bottom: 15px;
    }
    .payment-button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .cancel-button {
      display: block;
      width: 100%;
      padding: 15px;
      background-color: #f0f0f0;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
    }
    .payment-notice {
      font-size: 13px;
      color: #888;
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
<div layout:fragment="content">
  <div class="payment-container">
    <div class="payment-header">
      <h1 class="page-title">ê²°ì œí•˜ê¸°</h1>
    </div>

    <!-- ì£¼ë¬¸ ìš”ì•½ ì •ë³´ -->
    <section class="order-summary">
      <h2 class="section-title">ì£¼ë¬¸ ì •ë³´</h2>
      <div class="summary-row">
        <div class="summary-label">ì£¼ë¬¸ë²ˆí˜¸</div>
        <div class="summary-value" th:text="${order.orderNumber}">ORD12345</div>
      </div>
      <div class="summary-row">
        <div class="summary-label">ìƒí’ˆ ê¸ˆì•¡</div>
        <div class="summary-value" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT') + 'ì›'}">30,000ì›</div>
      </div>
      <div class="summary-row">
        <div class="summary-label">ë°°ì†¡ë¹„</div>
        <div class="summary-value" th:text="${#numbers.formatDecimal(order.shippingFee, 0, 'COMMA', 0, 'POINT') + 'ì›'}">3,000ì›</div>
      </div>
      <div class="summary-row" th:if="${order.discountAmount != null && order.discountAmount > 0}">
        <div class="summary-label">í• ì¸ ê¸ˆì•¡</div>
        <div class="summary-value" th:text="${'-' + #numbers.formatDecimal(order.discountAmount, 0, 'COMMA', 0, 'POINT') + 'ì›'}">-5,000ì›</div>
      </div>
      <div class="total-row">
        <div class="total-label">ì´ ê²°ì œ ê¸ˆì•¡</div>
        <div class="total-value" th:text="${#numbers.formatDecimal(order.finalAmount, 0, 'COMMA', 0, 'POINT') + 'ì›'}">28,000ì›</div>
      </div>
    </section>

    <!-- ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ -->
    <section class="payment-methods">
      <h2 class="section-title">ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ</h2>
      <div class="payment-method active" data-method="card" onclick="selectPaymentMethod('card', this)">
        <input type="radio" name="paymentMethod" id="method-card" class="payment-method-radio" value="card" checked>
        <span class="payment-method-icon">ğŸ’³</span>
        <label for="method-card" class="payment-method-name">ì‹ ìš©ì¹´ë“œ</label>
      </div>
      <div class="payment-method" data-method="trans" onclick="selectPaymentMethod('trans', this)">
        <input type="radio" name="paymentMethod" id="method-trans" class="payment-method-radio" value="trans">
        <span class="payment-method-icon">ğŸ¦</span>
        <label for="method-trans" class="payment-method-name">ì‹¤ì‹œê°„ ê³„ì¢Œì´ì²´</label>
      </div>
      <div class="payment-method" data-method="vbank" onclick="selectPaymentMethod('vbank', this)">
        <input type="radio" name="paymentMethod" id="method-vbank" class="payment-method-radio" value="vbank">
        <span class="payment-method-icon">ğŸ§</span>
        <label for="method-vbank" class="payment-method-name">ê°€ìƒê³„ì¢Œ</label>
      </div>
      <div class="payment-method" data-method="phone" onclick="selectPaymentMethod('phone', this)">
        <input type="radio" name="paymentMethod" id="method-phone" class="payment-method-radio" value="phone">
        <span class="payment-method-icon">ğŸ“±</span>
        <label for="method-phone" class="payment-method-name">íœ´ëŒ€í° ê²°ì œ</label>
      </div>
    </section>

    <!-- ì•½ê´€ ë™ì˜ -->
    <section class="payment-agreement">
      <h2 class="section-title">ì•½ê´€ ë™ì˜</h2>
      <div class="agreement-item">
        <input type="checkbox" id="agreement-all" class="agreement-checkbox" onclick="toggleAllAgreements()">
        <label for="agreement-all" class="agreement-text"><strong>ì „ì²´ ë™ì˜</strong></label>
      </div>
      <div class="agreement-item">
        <input type="checkbox" id="agreement-1" class="agreement-checkbox agreement-required" onchange="checkAgreements()">
        <label for="agreement-1" class="agreement-text">
          <span class="required">[í•„ìˆ˜]</span> êµ¬ë§¤ ì¡°ê±´ ë° ê²°ì œ ì§„í–‰ ë™ì˜
        </label>
      </div>
      <div class="agreement-item">
        <input type="checkbox" id="agreement-2" class="agreement-checkbox agreement-required" onchange="checkAgreements()">
        <label for="agreement-2" class="agreement-text">
          <span class="required">[í•„ìˆ˜]</span> ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜
        </label>
      </div>
      <div class="agreement-item">
        <input type="checkbox" id="agreement-3" class="agreement-checkbox agreement-required" onchange="checkAgreements()">
        <label for="agreement-3" class="agreement-text">
          <span class="required">[í•„ìˆ˜]</span> ê°œì¸ì •ë³´ ì œ3ì ì œê³µ ë™ì˜
        </label>
      </div>
    </section>

    <!-- ê²°ì œ ë²„íŠ¼ -->
    <button id="payment-button" class="payment-button" disabled onclick="requestPay()">ê²°ì œí•˜ê¸°</button>
    <a th:href="@{'/orders/' + ${order.id}}" class="cancel-button">ì·¨ì†Œ</a>

    <p class="payment-notice">
      ìœ„ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ê²°ì œê°€ ì§„í–‰ë©ë‹ˆë‹¤. ê²°ì œ ì§„í–‰ ì¤‘ì—ëŠ” í˜ì´ì§€ë¥¼ ë‹«ì§€ ë§ˆì„¸ìš”.
    </p>

    <!-- íˆë“  í•„ë“œë“¤ -->
    <input type="hidden" id="orderId" th:value="${order.id}">
    <input type="hidden" id="orderNumber" th:value="${order.orderNumber}">
    <input type="hidden" id="amount" th:value="${order.finalAmount}">
    <input type="hidden" id="buyerName" th:value="${order.shippingAddress.recipientName}">
    <input type="hidden" id="buyerTel" th:value="${order.shippingAddress.phone}">
    <input type="hidden" id="paymentId" th:value="${payment != null ? payment.id : ''}">
  </div>

  <!-- ê²°ì œ ìŠ¤í¬ë¦½íŠ¸ -->
  <script th:inline="javascript">
    let selectedMethod = 'card';

    // ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ
    function selectPaymentMethod(method, element) {
      selectedMethod = method;
      document.querySelector(`#method-${method}`).checked = true;

      // í™œì„±í™” í´ë˜ìŠ¤ ê´€ë¦¬
      document.querySelectorAll('.payment-method').forEach(el => {
        el.classList.remove('active');
      });
      element.classList.add('active');
    }

    // ì•½ê´€ ì „ì²´ ë™ì˜
    function toggleAllAgreements() {
      const allChecked = document.getElementById('agreement-all').checked;
      document.querySelectorAll('.agreement-checkbox').forEach(checkbox => {
        checkbox.checked = allChecked;
      });
      checkAgreements();
    }

    // ì•½ê´€ ë™ì˜ ì²´í¬
    function checkAgreements() {
      const requiredAgreements = document.querySelectorAll('.agreement-required');
      const allAgreed = Array.from(requiredAgreements).every(checkbox => checkbox.checked);

      document.getElementById('payment-button').disabled = !allAgreed;

      // ì „ì²´ ë™ì˜ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
      const allCheckboxes = document.querySelectorAll('.agreement-checkbox:not(#agreement-all)');
      const allChecked = Array.from(allCheckboxes).every(checkbox => checkbox.checked);
      document.getElementById('agreement-all').checked = allChecked;
    }

    // ê²°ì œ ìš”ì²­
    function requestPay() {
      // ì£¼ë¬¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const orderId = document.getElementById('orderId').value;
      const orderNumber = document.getElementById('orderNumber').value;
      const amount = document.getElementById('amount').value;
      const buyerName = document.getElementById('buyerName').value;
      const buyerEmail = "tjwlgns35@naver.com";
      const buyerTel = document.getElementById('buyerTel').value;
      const paymentId = document.getElementById('paymentId').value || null;

      // ê²°ì œ ìˆ˜ë‹¨
      const payMethod = selectedMethod;

      // ê²°ì œ ì •ë³´ê°€ ì—†ì„ ê²½ìš° ë¨¼ì € ìƒì„±
      if (!paymentId) {
        createPayment(orderId, payMethod)
                .then(response => {
                  if (response.success) {
                    processPay(response.data.id, orderNumber, amount, buyerName, buyerEmail, buyerTel, payMethod, orderId);
                  } else {
                    alert('ê²°ì œ ì •ë³´ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                  }
                })
                .catch(error => {
                  console.error('Error:', error);
                  alert('ê²°ì œ ì •ë³´ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
      } else {
        processPay(paymentId, orderNumber, amount, buyerName, buyerEmail, buyerTel, payMethod, orderId);
      }
    }

    // ê²°ì œ ì •ë³´ ìƒì„±
    function createPayment(orderId, paymentMethod) {
      return fetch('/api/payments/new', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          orderId: orderId,
          paymentMethod: paymentMethod
        })
      })
              .then(response => response.json());
    }

    // ê²°ì œ ì§„í–‰
    function processPay(paymentId, orderNumber, amount, buyerName, buyerEmail, buyerTel, payMethod, orderId) {
      // í¬íŠ¸ì› ê°ì²´ ì´ˆê¸°í™”
      const IMP = window.IMP;
      IMP.init('imp04015531'); // í¬íŠ¸ì› ê°€ë§¹ì  ì‹ë³„ì½”ë“œë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”

      // ê²°ì œ ìš”ì²­
      IMP.request_pay({
        pg: 'html5_inicis',           // PGì‚¬ ì½”ë“œ (ê³„ì•½í•œ PGì‚¬ì— ë§ê²Œ ë³€ê²½)
        pay_method: payMethod,         // ê²°ì œìˆ˜ë‹¨
        merchant_uid: orderNumber,     // ì£¼ë¬¸ë²ˆí˜¸
        name: 'ë§ˆì´ìƒµ ì£¼ë¬¸ ' + orderNumber, // ì£¼ë¬¸ëª…
        amount: amount,                // ê²°ì œê¸ˆì•¡
        buyer_email: buyerEmail,       // êµ¬ë§¤ì ì´ë©”ì¼
        buyer_name: buyerName,         // êµ¬ë§¤ì ì´ë¦„
        buyer_tel: buyerTel,           // êµ¬ë§¤ì ì „í™”ë²ˆí˜¸
        // m_redirect_url: '/orders/complete?orderId=' + orderId  // ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ ê²°ì œ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸ë  URL
      }, function(rsp) {
        if (rsp.success) {
          // ê²°ì œ ì„±ê³µ ì‹œ ì„œë²„ì— ê²°ì œ ê²€ì¦ ìš”ì²­
          verifyPayment(rsp, paymentId, amount, orderId);
        } else {
          // ê²°ì œ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
          handlePaymentFailure(rsp, paymentId);
        }
      });
    }

    // ê²°ì œ ê²€ì¦
    function verifyPayment(rsp, paymentId, amount, orderId) {
      fetch(`/api/payments/verify/${rsp.imp_uid}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          paymentId: paymentId,
          orderId: orderId,
          merchantUid: rsp.merchant_uid,
          impUid: rsp.imp_uid,
          amount: amount
        })
      })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  // ê²°ì œ ì„±ê³µ ì²˜ë¦¬
                  alert('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                  window.location.href = `/orders/complete?orderId=${orderId}`;
                } else {
                  // ê²°ì œëŠ” ì„±ê³µí–ˆìœ¼ë‚˜ ê²€ì¦ ì‹¤íŒ¨ ì‹œ (ê¸ˆì•¡ ë¶ˆì¼ì¹˜ ë“±)
                  alert('ê²°ì œ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message);
                }
              })
              .catch(error => {
                console.error('ê²°ì œ ê²€ì¦ ì˜¤ë¥˜:', error);
                alert('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              });
    }

    // ê²°ì œ ì‹¤íŒ¨ ì²˜ë¦¬
    function handlePaymentFailure(rsp, paymentId) {
      // ì„œë²„ì— ê²°ì œ ì‹¤íŒ¨ ì•Œë¦¼
      fetch(`/api/payments/${paymentId}/fail`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          reason: rsp.error_msg || 'ì‚¬ìš©ì ê²°ì œ ì·¨ì†Œ'
        })
      })
              .then(response => response.json())
              .then(data => {
                console.log('ê²°ì œ ì‹¤íŒ¨ ì²˜ë¦¬ ì™„ë£Œ:', data);
              })
              .catch(error => {
                console.error('ê²°ì œ ì‹¤íŒ¨ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
              });

      // ì‚¬ìš©ìì—ê²Œ ë©”ì‹œì§€ í‘œì‹œ
      alert('ê²°ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (rsp.error_msg || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
    }
  </script>
</div>
</body>
</html>